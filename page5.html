<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>P5 | Backlogs</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBJrlHhf-g-PgL7l_ZRFDCp-vzfHT1mj5Q",
  authDomain: "implant-governance.firebaseapp.com",
  projectId: "implant-governance",
  storageBucket: "implant-governance.firebasestorage.app",
  messagingSenderId: "649955056666",
  appId: "1:649955056666:web:02338c5bda4f285e8045a3"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
</script>

<script>
const session = JSON.parse(localStorage.getItem("loggedInUser") || "null");
if(!session) window.location.href="login.html";
</script>

<style>
:root{
  --primary:#2563eb; --primary-dark:#1e40af;
  --bg:#f8fafc; --card:#ffffff; --border:#e5e7eb;
  --text:#0f172a; --muted:#64748b;
  --danger:#dc2626; --warning:#f59e0b;
  --success:#10b981;
  --radius:14px; --shadow:0 10px 25px rgba(0,0,0,.08);
}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,system-ui;background:linear-gradient(180deg,#eef5ff,#f8fafc)}
.app{display:flex;min-height:100vh}

/* SIDEBAR */
.sidebar{width:270px;background:linear-gradient(180deg,var(--primary),var(--primary-dark));color:#fff;padding:24px 18px}
.brand{display:flex;gap:12px;align-items:center;margin-bottom:30px}
.logo{width:44px;height:44px;border-radius:12px;background:#fff;color:var(--primary);display:flex;align-items:center;justify-content:center;font-weight:800}
.nav a{display:flex;gap:12px;align-items:center;padding:12px 14px;border-radius:10px;text-decoration:none;color:#fff;font-weight:600;opacity:.85;margin-bottom:4px}
.nav a.active,.nav a:hover{background:rgba(255,255,255,.2);opacity:1}

/* MAIN */
.main{flex:1;padding:26px}
.page-title{font-size:22px;font-weight:800}

/* KPI */
.kpis{display:grid;grid-template-columns:repeat(5,1fr);gap:16px;margin-bottom:22px}
.kpi{background:#fff;border-radius:14px;padding:18px;box-shadow:var(--shadow)}
.kpi h4{margin:0;font-size:12px;color:var(--muted);text-transform:uppercase}
.kpi .val{font-size:26px;font-weight:800;color:var(--danger)}

/* CARD */
.card{background:#fff;border-radius:14px;padding:22px;box-shadow:var(--shadow)}
.table-wrap{border:1px solid var(--border);border-radius:12px;overflow-x:auto}
table{width:100%;border-collapse:collapse}
th,td{padding:14px;border-bottom:1px solid var(--border);font-size:14px;white-space:nowrap}
th{background:#f1f5f9;font-size:12px;color:var(--muted);text-transform:uppercase}

.badge{padding:4px 8px;border-radius:6px;font-size:11px;font-weight:700}
.low{background:#fef3c7;color:#92400e}
.mid{background:#ffedd5;color:#9a3412}
.high{background:#fee2e2;color:#991b1b}
.critical{background:#450a0a;color:#fff}
</style>
</head>

<body>
<div class="app">

<aside class="sidebar">
  <div class="brand"><div class="logo">P5</div><div><b>Implant Governance</b></div></div>
  <nav class="nav">
    <a href="index.html"><i class="fa fa-plus"></i> New Entry</a>
    <a href="page2.html"><i class="fa fa-list-check"></i> Working Summary</a>
    <a href="page3.html"><i class="fa fa-chart-line"></i> Analytics</a>
    <a href="page4.html"><i class="fa fa-check-circle"></i> Completed</a>
    <a href="page5.html" class="active"><i class="fa fa-triangle-exclamation"></i> Backlogs</a>
    <a href="page6.html"><i class="fa fa-cubes"></i> WallDrop</a>
    <button onclick="clearDatabase()" class="badge" style="margin-top:20px;background:#fee2e2;color:#991b1b">
      <i class="fa fa-trash"></i> Clear Database
    </button>
    <button onclick="logout()" style="background:none;border:none;color:#fff;padding:12px 14px;width:100%;text-align:left">
      <i class="fa fa-sign-out-alt"></i> Logout
    </button>
  </nav>
</aside>

<main class="main">

<div class="page-title">Critical Backlogs</div>

<div class="kpis">
  <div class="kpi"><h4>> 1 Day</h4><div class="val" id="k1">0</div></div>
  <div class="kpi"><h4>> 7 Days</h4><div class="val" id="k7">0</div></div>
  <div class="kpi"><h4>> 14 Days</h4><div class="val" id="k14">0</div></div>
  <div class="kpi"><h4>> 30 Days</h4><div class="val" id="k30">0</div></div>
  <div class="kpi"><h4>> 60 Days</h4><div class="val" id="k60">0</div></div>
</div>

<div class="card">
  <div style="display:flex;justify-content:space-between;margin-bottom:15px">
    <h3>Backlog Details</h3>
    <button onclick="exportBacklog()" style="padding:8px 16px;background:var(--primary);color:#fff;border:none;border-radius:8px">
      <i class="fa fa-file-excel"></i> Export
    </button>
  </div>

  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Jobcard</th><th>SO</th><th>Type</th>
          <th>Expected</th><th>Delay</th><th>Postpone</th><th>Severity</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</div>

</main>
</div>

<script>
let records=[];

const parseDate=d=>{
  if(!d)return null;
  const p=d.split(" ")[0].split("/");
  return new Date(p[2],p[1]-1,p[0]);
};

function diffDays(d){
  const n=new Date();n.setHours(0,0,0,0);
  return Math.floor((n-d)/86400000);
}

db.collection("records").onSnapshot(snap=>{
  records=[];
  snap.forEach(d=>records.push(d.data()));
  render();
});

function render(){
  const body=document.getElementById("tbody");
  body.innerHTML="";
  let c1=0,c7=0,c14=0,c30=0,c60=0;

  records.forEach(r=>{
    if(r.status==="Completed")return;
    const d=parseDate(r.todayFollow);
    if(!d)return;
    const days=diffDays(d);
    if(days<1)return;

    if(days>=1)c1++;
    if(days>=7)c7++;
    if(days>=14)c14++;
    if(days>=30)c30++;
    if(days>=60)c60++;

    let sev="Low",cls="low";
    if(days>60){sev="Critical";cls="critical";}
    else if(days>30){sev="High";cls="high";}
    else if(days>14){sev="Mid";cls="mid";}

    body.innerHTML+=`
      <tr>
        <td><b>${r.jobcard}</b></td>
        <td>${r.soNumber||"-"}</td>
        <td>${r.type}</td>
        <td>${r.todayFollow}</td>
        <td style="color:var(--danger);font-weight:700">${days} Days</td>
        <td>${r.postponeCount||0}</td>
        <td><span class="badge ${cls}">${sev}</span></td>
      </tr>`;
  });

  k1.innerText=c1;k7.innerText=c7;k14.innerText=c14;k30.innerText=c30;k60.innerText=c60;
}

function exportBacklog(){
  const data=records.filter(r=>{
    const d=parseDate(r.todayFollow);
    return r.status!=="Completed" && d && diffDays(d)>=1;
  }).map(r=>({
    Jobcard:r.jobcard,
    SO:r.soNumber,
    Type:r.type,
    Expected:r.todayFollow,
    DelayDays:diffDays(parseDate(r.todayFollow)),
    Postpone:r.postponeCount||0
  }));
  const ws=XLSX.utils.json_to_sheet(data);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,"Backlogs");
  XLSX.writeFile(wb,"Backlogs_Report.xlsx");
}

async function clearDatabase(){
  if(!confirm("Delete ALL records?"))return;
  const snap=await db.collection("records").get();
  const batch=db.batch();
  snap.forEach(d=>batch.delete(d.ref));
  await batch.commit();
  alert("Database cleared");
}

function logout(){
  localStorage.removeItem("loggedInUser");
  window.location.href="login.html";
}
</script>
</body>
</html>

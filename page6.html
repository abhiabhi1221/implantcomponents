<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>P6 | WallDrop</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBJrlHhf-g-PgL7l_ZRFDCp-vzfHT1mj5Q",
    authDomain: "implant-governance.firebaseapp.com",
    projectId: "implant-governance",
    storageBucket: "implant-governance.firebasestorage.app",
    messagingSenderId: "649955056666",
    appId: "1:649955056666:web:02338c5bda4f285e8045a3"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
</script>

<script>
const session = JSON.parse(localStorage.getItem("loggedInUser") || "null");
if(!session){ window.location.href = "login.html"; }
</script>
<style>
:root{
  --primary:#2563eb; --primary-dark:#1e40af; --bg:#f8fafc; --card:#ffffff;
  --border:#e5e7eb; --text:#0f172a; --muted:#64748b; --success:#10b981;
  --warning:#f59e0b; --orange:#f97316; --danger:#ef4444; --radius:14px;
  --shadow:0 10px 25px rgba(0,0,0,.08);
}
*{box-sizing:border-box}
body{ margin:0; font-family:Inter,system-ui; background:linear-gradient(180deg,#eef5ff,#f8fafc); color:var(--text); }
.app{display:flex;min-height:100vh}

.sidebar{ width:270px; background:linear-gradient(180deg,var(--primary),var(--primary-dark)); color:#fff; padding:24px 18px; }
.brand{display:flex;gap:12px;align-items:center;margin-bottom:30px}
.logo{ width:44px;height:44px;border-radius:12px; background:#fff;color:var(--primary); display:flex;align-items:center;justify-content:center; font-weight:800 }
.nav a{ display:flex;gap:12px;align-items:center; padding:12px 14px;border-radius:10px; text-decoration:none;color:#fff;font-weight:600; opacity:.85; margin-bottom:4px; }
.nav a.active,.nav a:hover{background:rgba(255,255,255,.2);opacity:1}

.main{flex:1;padding:26px;overflow:auto}
.page-header{margin-bottom:20px}
.page-title{font-size:22px;font-weight:800}
.page-sub{font-size:13px;color:var(--muted)}

.type-grid{ display:grid; grid-template-columns:repeat(auto-fill,minmax(300px,1fr)); gap:18px; transition: all 0.4s ease; }
.type-grid.focus-mode { grid-template-columns: 1fr; }

.type-card{ background:var(--card); border-radius:var(--radius); padding:18px; box-shadow:var(--shadow); cursor:pointer; border:2px solid transparent; transition: all 0.3s ease; height: fit-content; }
.type-card:hover{border-color:var(--primary)}
.type-card.enlarged { grid-column: 1 / -1; border-color: var(--primary); transform: scale(1.01); cursor: default; }
.type-card.hidden { display: none; }

.type-head{ display:flex; justify-content:space-between; align-items:center; padding-bottom: 10px; }
.type-head h3{margin:0;font-size:16px}
.type-count{font-size:22px;font-weight:800;color:var(--primary)}

.wall{ margin-top:14px; padding:14px; background:#f8fafc; border:1px solid var(--border); border-radius:12px; }
.wall-row{ display:grid; gap:8px; margin-bottom:10px; }
.cols-1{ grid-template-columns: 1fr; }
.cols-2{ grid-template-columns: repeat(2, 1fr); }
.cols-3{ grid-template-columns: repeat(3, 1fr); }
.cols-4{ grid-template-columns: repeat(4, 1fr); }

.rack{ background:#fff; border-radius:8px; padding:6px; border:1.5px solid var(--border); cursor:pointer; transition:.2s; text-align:center; }
.rack:hover{border-color:var(--primary); transform: translateY(-2px); box-shadow: var(--shadow);}
.rack h4{ margin:0 0 2px 0; font-size:11px; color: var(--muted); font-weight:700; }
.rack .count{ font-size:13px; font-weight:800; margin-bottom:4px; }

.slots{ display:grid; grid-template-columns:repeat(8,1fr); gap:1px; }
.slot{ width:100%; aspect-ratio:1; height:12px; border-radius:1px; background:#e5e7eb; }
.fill.green{background:var(--success)}
.fill.yellow{background:var(--warning)}
.fill.orange{background:var(--orange)}
.fill.red{background:var(--danger)}

.back-btn { display: none; margin-bottom: 15px; background: var(--muted); color: white; padding: 8px 16px; border-radius: 8px; font-size: 13px; border: none; cursor: pointer; font-weight: 600; }
.enlarged .back-btn { display: inline-block; }

/* MODAL */
.modal-overlay{ display:none; position:fixed; inset:0; background:rgba(15,23,42,.7); backdrop-filter:blur(4px); align-items:center; justify-content:center; z-index:999 }
.modal{ background:#fff; width:900px; max-width:95%; border-radius:16px; padding:24px; max-height:90vh; overflow:auto }
.modal-header{ display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid var(--border); padding-bottom:10px }
.close-btn{ font-size:22px; background:none; border:none; cursor:pointer }
table{width:100%;border-collapse:collapse;margin-top:12px}
th,td{ padding:10px; border-bottom:1px solid var(--border); font-size:13px; text-align:left }

.export-btn { margin-top: 16px; padding: 10px 16px; background: var(--success); color: #fff; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; }
</style>
</head>

<body>

<div class="modal-overlay" id="modal">
  <div class="modal">
    <div class="modal-header">
      <div>
        <h3 id="mTitle"></h3>
        <small id="mSub" style="color:var(--muted)"></small>
      </div>
      <button class="close-btn" onclick="closeModal()">×</button>
    </div>
    <div id="modalBody"></div>
  </div>
</div>

<div class="app">
  <aside class="sidebar">
    <div class="brand"><div class="logo">P6</div><div><div style="font-weight:700">Implant Operational</div></div></div>
    <nav class="nav">
      <div style="margin:14px 10px 6px;font-size:11px;font-weight:700;opacity:.7;letter-spacing:.6px">COMPONENT DEPT</div>
      <a href="index.html"><i class="fa fa-plus"></i> New Entry</a>
      <a href="page2.html"><i class="fa fa-list-check"></i> Working Summary</a>
      <a href="page3.html"><i class="fa fa-chart-line"></i> Analytics</a>
      <a href="page4.html"><i class="fa fa-check-circle"></i> Completed</a>
      <a href="page5.html"><i class="fa fa-triangle-exclamation"></i> Backlogs</a>
      <a href="page6.html" class="active"><i class="fa fa-cubes"></i> WallDrop</a>
      <div style="margin:18px 10px 6px;font-size:11px;font-weight:700;opacity:.7;letter-spacing:.6px">ATTACHMENT DEPT</div>
      <a href="page7.html"><i class="fa fa-paperclip"></i> Attachment DC</a>
      <a href="page8.html"><i class="fa fa-cubes"></i> Attachment WallDrop</a>
  <button class="btn-sidebar" onclick="clearDatabase()">
      <i class="fa fa-trash-can"></i> Clear Database
    </button>
      <button onclick="logout()" style="background:none;border:none;color:#fff;margin-top:20px;font-weight:600;cursor:pointer;width:100%;text-align:left;padding-left:14px">
        <i class="fa fa-sign-out-alt"></i> Logout
      </button>
    </nav>
  </aside>

  <main class="main">
    <div class="page-header">
      <div class="page-title">Virtual WallDrop</div>
      <div class="page-sub" id="instruction">Select a Type to view physical rack mapping</div>
    </div>
    <div class="type-grid" id="gridContainer"></div>
  </main>
</div>

<script>
const TYPES=[
  'COMPONENTS',
  'NEW MODEL/ NEW SCAN',
  'ABUTMENT MILLING TRIAL',
  'M F FRAME TRIAL',
  'METAL TRIAL',
  'JIG TRIAL',
  'OTHERS',
  'RESIN TRIAL',
  'SPECIAL TRAY',
  'SPECIAL BITE BLOCK',
  'BITE BLOCK',
  'TEETH SETTING WITH FRAME',
  'TEETH SET'
];


const TYPE_COLUMNS = { 'ABUTMENT MILLING TRIAL': 1, 'M F FRAME TRIAL': 1,'NEW MODEL/ NEW SCAN': 2, 'SPECIAL TRAY': 2, 'BITE BLOCK': 2, 'TEETH SETTING WITH FRAME': 2, 'TEETH SET': 2, 'OTHERS': 1, 'SPECIAL BITE BLOCK': 1 };
const TYPE_COLUMN_START = {
  'COMPONENTS': 1,
  'NEW MODEL/ NEW SCAN': 4,
  'ABUTMENT MILLING TRIAL': 6,
  'M F FRAME TRIAL': 7,
  'METAL TRIAL': 8,
  'JIG TRIAL': 11,
  'OTHERS': 14,
  'RESIN TRIAL': 15,
  'SPECIAL TRAY': 18,
  'SPECIAL BITE BLOCK': 20,
  'BITE BLOCK': 21,
  'TEETH SETTING WITH FRAME': 23,
  'TEETH SET': 25
};


const RACK_SIZE = 32;


function severity(p){ if(p<0.4) return 'green'; if(p<0.6) return 'yellow'; if(p<0.8) return 'orange'; return 'red'; }
let records = [];

db.collection("records")
  .onSnapshot(snapshot => {
    records = [];
    snapshot.forEach(doc => records.push(doc.data()));
    render();
  });

function getRecords(){
  return records.filter(r => r.status !== 'Completed');
}

function render(){
  const all=getRecords();
  const grid = document.getElementById('gridContainer');
  grid.innerHTML=TYPES.map(type=>{
    const items=all.filter(r=>r.type===type);
    return `
      <div class="type-card" onclick="toggleEnlarge(this,'${type}')">
        <button class="back-btn" onclick="event.stopPropagation(); resetGrid()"><i class="fa fa-arrow-left"></i> Back to Types</button>
        <div class="type-head">
          <h3>${type}</h3>
          <div class="type-count">${items.length}</div>
        </div>
        <div class="wall" style="display:none"></div>
      </div>`;
  }).join('');
}

function toggleEnlarge(card, type) {
  if (card.classList.contains('enlarged')) return;
  document.querySelectorAll('.type-card').forEach(c => {
    if (c === card) { c.classList.add('enlarged'); } else { c.classList.add('hidden'); }
  });
  document.getElementById('gridContainer').classList.add('focus-mode');
  document.getElementById('instruction').innerText = `Viewing Physical Rack Mapping for: ${type}`;
  showRacks(card, type);
}

function resetGrid() {
  document.querySelectorAll('.type-card').forEach(c => {
    c.classList.remove('enlarged', 'hidden');
    c.querySelector('.wall').style.display = 'none';
  });
  document.getElementById('gridContainer').classList.remove('focus-mode');
  document.getElementById('instruction').innerText = "Select a Type to view physical rack mapping";
}

function showRacks(card, type){
  const wall = card.querySelector('.wall');
  wall.style.display = 'block';
  const items = getRecords().filter(r => r.type === type).reverse();
  
  const columns = TYPE_COLUMNS[type] || 3;
  const totalRows = 6;
  const ROW_LABELS = ['A','B','C','D','E','F'];
  const startCol = TYPE_COLUMN_START[type] || 1;

  let html = '';
  let rackIndexCounter = 0;

  for(let row = 0; row < totalRows; row++){
    html += `<div class="wall-row cols-${columns}">`;
    for(let col = 0; col < columns; col++){
      const rackName = `${startCol + col}${ROW_LABELS[row]}`;
      const rackItems = items.slice(rackIndexCounter * RACK_SIZE, (rackIndexCounter + 1) * RACK_SIZE);
      const count = rackItems.length;
      const filledSlots = Math.ceil((count / RACK_SIZE) * 8);
      const cls = severity(count / RACK_SIZE);

      html += `
        <div class="rack" onclick="event.stopPropagation(); openRack('${type}', ${rackIndexCounter}, '${rackName}')">
          <h4>${rackName}</h4>
          <div class="count">${count} / ${RACK_SIZE}</div>
          <div class="slots">
            ${Array(8).fill(0).map((_, s) => `<div class="slot ${s < filledSlots ? 'fill ' + cls : ''}"></div>`).join('')}
          </div>
        </div>
      `;
      rackIndexCounter++;
    }
    html += `</div>`;
  }
  wall.innerHTML = html;
}

function openRack(type, idx, rackName){
  const allItems = getRecords().filter(r => r.type === type).reverse();
  const items = allItems.slice(idx * RACK_SIZE, (idx + 1) * RACK_SIZE);

  document.getElementById('mTitle').innerText = `${type} – Rack ${rackName}`;
  document.getElementById('mSub').innerText = `${items.length} Active Jobcards (Capacity: ${RACK_SIZE})`;

  document.getElementById('modalBody').innerHTML = `
    <table>
      <thead><tr><th>Jobcard</th><th>SO Number</th><th>Created</th><th>Follow-Up</th></tr></thead>
      <tbody>
      ${items.map(r => `
        <tr>
          <td><b>${r.jobcard}</b></td>
          <td style="color:var(--primary); font-weight:700">${r.soNumber || '-'}</td>
          <td>${r.timestamp || '-'}</td>
          <td>${r.todayFollow}</td>
        </tr>`).join('')}
      </tbody>
    </table>
    ${items.length > 0 ? `<button class="export-btn" onclick="exportRack('${type}', ${idx}, '${rackName}')"><i class="fa fa-file-excel"></i> Export Rack Data</button>` : '<p style="margin-top:15px">Rack is empty</p>'}`;
  document.getElementById('modal').style.display = 'flex';
}

function exportRack(type, idx, rackName){
  const allItems = getRecords().filter(r => r.type === type).reverse();
  const items = allItems.slice(idx * RACK_SIZE, (idx + 1) * RACK_SIZE).map(r => ({
    Jobcard: r.jobcard,
    SO_Number: r.soNumber || '',
    Created: r.timestamp || '',
    Follow_Up: r.todayFollow,
    Type: r.type,
    Rack: rackName
  }));
  const ws = XLSX.utils.json_to_sheet(items);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Rack_Data');
  XLSX.writeFile(wb, `WallDrop_${rackName}_${type}.xlsx`);
}

function closeModal(){ document.getElementById('modal').style.display='none'; }
function logout(){ localStorage.removeItem("loggedInUser"); window.location.href = "login.html"; }
window.onclick = e => { if(e.target === document.getElementById('modal')) closeModal(); }


</script>
</body>
</html>

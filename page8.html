<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>P8 | Attachment WallDrop</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBJrlHhf-g-PgL7l_ZRFDCp-vzfHT1mj5Q",
  authDomain: "implant-governance.firebaseapp.com",
  projectId: "implant-governance",
  storageBucket: "implant-governance.firebasestorage.app",
  messagingSenderId: "649955056666",
  appId: "1:649955056666:web:02338c5bda4f285e8045a3"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
</script>

<script>
const session = JSON.parse(localStorage.getItem("loggedInUser") || "null");
if(!session) window.location.href="login.html";
</script>

<style>
:root{
  --primary:#2563eb;--primary-dark:#1e40af;
  --bg:#f8fafc;--card:#ffffff;--border:#e5e7eb;
  --text:#0f172a;--muted:#64748b;
  --success:#10b981;--warning:#f59e0b;
  --orange:#f97316;--danger:#ef4444;
  --radius:14px;--shadow:0 10px 25px rgba(0,0,0,.08);
}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,system-ui;background:linear-gradient(180deg,#eef5ff,#f8fafc)}
.app{display:flex;min-height:100vh}

/* SIDEBAR */
.sidebar{width:270px;background:linear-gradient(180deg,var(--primary),var(--primary-dark));color:#fff;padding:24px 18px}
.brand{display:flex;gap:12px;align-items:center;margin-bottom:30px}
.logo{width:44px;height:44px;border-radius:12px;background:#fff;color:var(--primary);display:flex;align-items:center;justify-content:center;font-weight:800}
.nav a{display:flex;gap:12px;align-items:center;padding:12px 14px;border-radius:10px;text-decoration:none;color:#fff;font-weight:600;opacity:.85;margin-bottom:4px}
.nav a.active,.nav a:hover{background:rgba(255,255,255,.2);opacity:1}

/* MAIN */
.main{flex:1;padding:26px}
.page-title{font-size:22px;font-weight:800;margin-bottom:18px}

/* WALL */
.wall{background:#f8fafc;border:1px solid var(--border);border-radius:12px;padding:16px}
.wall-row{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-bottom:10px}
.rack{
  background:#fff;border-radius:8px;padding:8px;
  border:1.5px solid var(--border);text-align:center;
  cursor:pointer;transition:.2s
}
.rack:hover{border-color:var(--primary);box-shadow:var(--shadow);transform:translateY(-2px)}
.rack h4{margin:0;font-size:12px;color:var(--muted)}
.rack .count{font-weight:800;margin:4px 0}

.slots{display:grid;grid-template-columns:repeat(6,1fr);gap:2px}
.slot{height:14px;background:#e5e7eb;border-radius:2px}
.fill.green{background:var(--success)}
.fill.yellow{background:var(--warning)}
.fill.orange{background:var(--orange)}
.fill.red{background:var(--danger)}

/* MODAL */
.modal-bg{
  display:none;position:fixed;inset:0;
  background:rgba(15,23,42,.7);
  backdrop-filter:blur(4px);
  align-items:center;justify-content:center;
  z-index:999
}
.modal{
  background:#fff;width:850px;max-width:95%;
  border-radius:16px;padding:24px;
  max-height:90vh;overflow:auto
}
.modal-header{display:flex;justify-content:space-between;border-bottom:1px solid var(--border);padding-bottom:10px}
.close{background:none;border:none;font-size:22px;cursor:pointer}
table{width:100%;border-collapse:collapse;margin-top:12px}
th,td{padding:10px;border-bottom:1px solid var(--border);font-size:13px;text-align:left}
.export-btn{
  margin-top:16px;padding:10px 16px;
  background:var(--success);color:#fff;
  border:none;border-radius:8px;
  font-weight:600;cursor:pointer
}
</style>
</head>

<body>

<!-- MODAL -->
<div class="modal-bg" id="modal">
  <div class="modal">
    <div class="modal-header">
      <div>
        <h3 id="mTitle"></h3>
        <small id="mSub" style="color:var(--muted)"></small>
      </div>
      <button class="close" onclick="closeModal()">Ã—</button>
    </div>
    <div id="modalBody"></div>
  </div>
</div>

<div class="app">

<aside class="sidebar">
  <div class="brand"><div class="logo">P8</div><b>Implant Governance</b></div>
  <nav class="nav">
    <a href="index.html"><i class="fa fa-plus"></i> New Entry</a>
    <a href="page2.html"><i class="fa fa-list-check"></i> Working Summary</a>
    <a href="page3.html"><i class="fa fa-chart-line"></i> Analytics</a>
    <a href="page4.html"><i class="fa fa-check-circle"></i> Completed</a>
    <a href="page5.html"><i class="fa fa-triangle-exclamation"></i> Backlogs</a>
    <a href="page6.html"><i class="fa fa-cubes"></i> WallDrop</a>

    <a href="page7.html"><i class="fa fa-paperclip"></i> Attachment DC</a>
    <a href="page8.html" class="active"><i class="fa fa-cubes"></i> Attachment WallDrop</a>

    <button onclick="logout()" style="background:none;border:none;color:#fff;padding:12px 14px;text-align:left">
      <i class="fa fa-sign-out-alt"></i> Logout
    </button>
  </nav>
</aside>

<main class="main">
  <div class="page-title">Attachment WallDrop</div>
  <div class="wall" id="wall"></div>
</main>

</div>

<script>
const RACK_CAP = 42;
const COLS = [31,32,33,34,35];
const ROWS = ["A","B","C","D"];
let records=[];

db.collection("attachment_dc").onSnapshot(snap=>{
  records=[];
  snap.forEach(d=>{
    const r=d.data();
    if(r.status!=="Completed") records.push({...r,id:d.id});
  });
  records.reverse();
  render();
});

function severity(p){
  if(p<0.4) return "green";
  if(p<0.6) return "yellow";
  if(p<0.8) return "orange";
  return "red";
}

function render(){
  let idx=0,html="";
  ROWS.forEach(r=>{
    html+=`<div class="wall-row">`;
    COLS.forEach(c=>{
      const name=`${c}${r}`;
      const items=records.slice(idx,idx+RACK_CAP);
      const filled=Math.ceil((items.length/RACK_CAP)*6);
      const cls=severity(items.length/RACK_CAP);

      html+=`
        <div class="rack" onclick="openRack('${name}',${idx})">
          <h4>${name}</h4>
          <div class="count">${items.length}/${RACK_CAP}</div>
          <div class="slots">
            ${Array(6).fill(0).map((_,i)=>`
              <div class="slot ${i<filled?'fill '+cls:''}"></div>
            `).join("")}
          </div>
        </div>`;
      idx+=RACK_CAP;
    });
    html+=`</div>`;
  });
  wall.innerHTML=html;
}

function openRack(name,start){
  const items=records.slice(start,start+RACK_CAP);
  mTitle.innerText=`Rack ${name}`;
  mSub.innerText=`${items.length} Jobcards`;

  modalBody.innerHTML=`
    <table>
      <thead><tr><th>Jobcard</th><th>Box</th><th>Entry Time</th></tr></thead>
      <tbody>
        ${items.map(r=>`
          <tr>
            <td><b>${r.jobcard}</b></td>
            <td>${r.box||"-"}</td>
            <td>${r.timestamp}</td>
          </tr>
        `).join("")}
      </tbody>
    </table>
    ${items.length?`
      <button class="export-btn" onclick="exportRack('${name}',${start})">
        Export Rack
      </button>`:""}
  `;
  modal.style.display="flex";
}

function exportRack(name,start){
  const items=records.slice(start,start+RACK_CAP).map(r=>({
    Jobcard:r.jobcard,
    Box:r.box,
    Time:r.timestamp,
    Rack:name
  }));
  const ws=XLSX.utils.json_to_sheet(items);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,"Rack");
  XLSX.writeFile(wb,`Attachment_Rack_${name}.xlsx`);
}

function closeModal(){ modal.style.display="none"; }
window.onclick=e=>{ if(e.target===modal) closeModal(); }

function logout(){
  localStorage.removeItem("loggedInUser");
  window.location.href="login.html";
}
</script>
</body>
</html>

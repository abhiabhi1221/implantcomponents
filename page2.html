<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>P2 | Working Summary</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBJrlHhf-g-PgL7l_ZRFDCp-vzfHT1mj5Q",
    authDomain: "implant-governance.firebaseapp.com",
    projectId: "implant-governance",
    storageBucket: "implant-governance.firebasestorage.app",
    messagingSenderId: "649955056666",
    appId: "1:649955056666:web:02338c5bda4f285e8045a3"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
</script>

<script>
const session = JSON.parse(localStorage.getItem("loggedInUser") || "null");
if (!session) { window.location.href = "login.html"; }
</script>

<style>
/* --- THEME VARIABLES --- */
:root {
  --primary: #2563eb; --primary-dark: #1e40af; --bg: #f8fafc; --card: #ffffff;
  --border: #e5e7eb; --text: #0f172a; --muted: #64748b; --danger: #dc2626;
  --success: #10b981; --warning: #f59e0b; --info: #3b82f6;
  --radius: 14px; --shadow: 0 10px 25px rgba(0,0,0,.08);
}

* { box-sizing: border-box; outline: none; }
body { margin: 0; font-family: Inter, system-ui; background: linear-gradient(180deg, #eef5ff, #f8fafc); color: var(--text); }
.app { display: flex; min-height: 100vh; }

/* --- SIDEBAR --- */
.sidebar { width: 270px; background: linear-gradient(180deg, var(--primary), var(--primary-dark)); color: #fff; padding: 24px 18px; display: flex; flex-direction: column; }
.brand { display: flex; gap: 12px; align-items: center; margin-bottom: 30px; }
.logo { width: 44px; height: 44px; border-radius: 12px; background: #fff; color: var(--primary); display: flex; align-items: center; justify-content: center; font-weight: 800; }
.nav { flex: 1; }
.nav a { display: flex; gap: 12px; align-items: center; padding: 12px 14px; border-radius: 10px; text-decoration: none; color: #fff; font-weight: 600; opacity: .85; margin-bottom: 4px; transition: 0.2s; }
.nav a.active, .nav a:hover { background: rgba(255,255,255,.2); opacity: 1; }
.btn-sidebar { width: 100%; text-align: left; background: rgba(255,255,255,0.1); border: none; color: #ff8a8a; padding: 10px; border-radius: 8px; font-weight: 600; cursor: pointer; margin-bottom: 10px; transition: 0.2s; }
.btn-sidebar:hover { background: rgba(255,255,255,0.2); color: white; }

/* Text-only button styling */
.btn-complete { 
  background: #dcfce7; 
  color: #166534; 
  border: 1px solid #bbf7d0; 
}

.btn-postpone { 
  background: #dbeafe; 
  color: #1e40af; 
  border: 1px solid #bfdbfe; 
}

/* Ensure buttons have enough padding for text */
.btn {
  padding: 8px 14px;
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 0.3px;
}

/* --- MAIN CONTENT --- */
.main { flex: 1; padding: 26px; overflow: hidden; display: flex; flex-direction: column; }
.page-header { margin-bottom: 20px; flex-shrink: 0; }
.page-title { font-size: 22px; font-weight: 800; }

/* --- KPI CARDS --- */
.kpis { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 22px; flex-shrink: 0; }
.kpi { background: var(--card); border-radius: var(--radius); padding: 18px; box-shadow: var(--shadow); cursor: pointer; border: 2px solid transparent; transition: 0.2s; }
.kpi:hover { transform: translateY(-3px); border-color: var(--primary); }
.kpi.active { border-color: var(--primary); background: #f0f7ff; }
.kpi h4 { margin: 0; font-size: 13px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; }
.kpi .val { font-size: 28px; font-weight: 800; margin-top: 6px; color: var(--primary); }

/* --- CARD & TABLE --- */
.card { background: var(--card); border-radius: var(--radius); padding: 20px; box-shadow: var(--shadow); display: flex; flex-direction: column; flex: 1; overflow: hidden; }
.table-wrap { border: 1px solid var(--border); border-radius: 12px; overflow: auto; flex: 1; position: relative; }
table { width: 100%; border-collapse: collapse; min-width: 1000px; }

/* STICKY HEADER */
thead th { background: #f1f5f9; padding: 14px; font-size: 12px; text-transform: uppercase; color: var(--muted); text-align: left; font-weight: 700; position: sticky; top: 0; z-index: 10; border-bottom: 1px solid var(--border); }
tbody td { padding: 14px; border-bottom: 1px solid var(--border); font-size: 14px; vertical-align: middle; }
tbody tr:hover { background: #f8fafc; }

/* --- BUTTONS --- */
.btn { padding: 8px 12px; border-radius: 8px; border: none; font-weight: 700; font-size: 11px; cursor: pointer; display: inline-flex; gap: 4px; align-items: center; transition: transform 0.1s; }
.btn:active { transform: scale(0.98); }
.btn-ghost { background: #fff; border: 1px solid var(--border); color: var(--primary); }
.btn-ghost:hover { background: #f1f5f9; }
.btn-primary { background: var(--primary); color: #fff; }
.btn-danger { background: #fee2e2; color: var(--danger); }

/* --- STATUS BADGES --- */
.badge { padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 700; display: inline-flex; align-items: center; gap: 5px; text-transform: uppercase; letter-spacing: 0.5px; }
/* Backlog = RED */
.badge-red { background: #fef2f2; color: #dc2626; border: 1px solid #fecaca; }
/* Active = GREEN */
.badge-green { background: #f0fdf4; color: #16a34a; border: 1px solid #bbf7d0; }
/* Postponed = BLUE */
.badge-blue { background: #eff6ff; color: #2563eb; border: 1px solid #bfdbfe; }

/* --- EXTRAS --- */
.expand-btn { cursor: pointer; color: var(--primary); transition: 0.3s; margin-right: 8px; width: 20px; text-align: center; }
.remark-row { background: #f9fafb; display: none; }
.remark-row.show { display: table-row; animation: fadeIn 0.3s; }
.remark-box { padding: 12px 20px; border-left: 4px solid var(--primary); font-size: 13px; color: #475569; margin: 10px 20px; background: white; border-radius: 0 8px 8px 0; border: 1px solid var(--border); }
.remark-entry { border-bottom: 1px dashed var(--border); padding-bottom: 6px; margin-bottom: 6px; }
.remark-entry:last-child { border: none; margin: 0; padding: 0; }
.remark-time { font-size: 10px; font-weight: 700; color: var(--muted); margin-right: 6px; }

/* --- MODAL --- */
.modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,.5); z-index: 999; backdrop-filter: blur(2px); align-items: center; justify-content: center; }
.modal { background: #fff; width: 420px; border-radius: 12px; padding: 24px; box-shadow: 0 20px 40px rgba(0,0,0,.2); animation: popUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
.form-label { display: block; font-size: 13px; font-weight: 600; color: var(--muted); margin-bottom: 6px; }
.form-input { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 14px; font-family: inherit; }
.form-input:focus { border-color: var(--primary); outline: none; }

/* --- TOAST --- */
.toast-container { position: fixed; bottom: 24px; right: 24px; z-index: 1000; display: flex; flex-direction: column; gap: 10px; }
.toast { background: white; padding: 16px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); display: flex; align-items: center; gap: 12px; min-width: 300px; border-left: 4px solid var(--primary); transform: translateX(120%); transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55); }
.toast.show { transform: translateX(0); }
.toast-success { border-color: var(--success); } .toast-success i { color: var(--success); }
.toast-error { border-color: var(--danger); } .toast-error i { color: var(--danger); }

@keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
@keyframes popUp { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
@media(max-width:1100px) { .kpis { grid-template-columns: repeat(2, 1fr); } }
</style>
</head>

<body>
<div class="app">
  <aside class="sidebar">
    <div class="brand">
      <div class="logo">P2</div>
      <div><div style="font-weight:700">Implant Governance</div><div style="font-size:12px;opacity:.8">Operational Control</div></div>
    </div>
    <nav class="nav">
      <div style="margin:14px 10px 6px;font-size:11px;font-weight:700;opacity:.7;letter-spacing:.6px">COMPONENT DEPT</div>
      <a href="index.html"><i class="fa fa-plus"></i> New Entry</a>
      <a href="page2.html" class="active"><i class="fa fa-list-check"></i> Working Summary</a>
      <a href="page3.html"><i class="fa fa-chart-line"></i> Analytics</a>
      <a href="page4.html"><i class="fa fa-check-circle"></i> Completed</a>
      <a href="page5.html"><i class="fa fa-triangle-exclamation"></i> Backlogs</a>
      <a href="page6.html"><i class="fa fa-cubes"></i> WallDrop</a>
      <div style="margin:18px 10px 6px;font-size:11px;font-weight:700;opacity:.7;letter-spacing:.6px">ATTACHMENT DEPT</div>
      <a href="page7.html"><i class="fa fa-paperclip"></i> Attachment DC</a>
      <a href="page8.html"><i class="fa fa-cubes"></i> Attachment WallDrop</a>
      
      <div style="margin-top:auto; padding-top:20px; border-top:1px solid rgba(255,255,255,0.1)">
        <button class="btn-sidebar" onclick="clearDatabase()">
          <i class="fa fa-trash-can"></i> Clear Database
        </button>
        <button onclick="logout()" style="background:none;border:none;color:#fff;width:100%;font-weight:600;cursor:pointer;text-align:left;padding:10px">
          <i class="fa fa-sign-out-alt"></i> Logout
        </button>
      </div>
    </nav>
  </aside>

  <main class="main">
    <div class="page-header"><div class="page-title">Active Working Summary</div></div>

    <div class="kpis">
      <div class="kpi active" id="kpi-Total" onclick="setFilter('Total')"><h4>Total Active</h4><div class="val" id="kTotal">0</div></div>
      <div class="kpi" id="kpi-Today" onclick="setFilter('Today')"><h4>Due Today</h4><div class="val" id="kToday">0</div></div>
      <div class="kpi" id="kpi-Upcoming" onclick="setFilter('Upcoming')"><h4>Upcoming</h4><div class="val" id="kUpcoming">0</div></div>
      <div class="kpi" id="kpi-Backlog" onclick="setFilter('Backlog')"><h4>Backlogs</h4><div class="val" id="kBacklog">0</div></div>
    </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:14px;flex-wrap:wrap">
        <h3 style="margin:0;font-size:16px;font-weight:700">Follow-Up Records</h3>
        <div style="display:flex;gap:10px;align-items:center">
          <div style="position:relative">
            <i class="fa fa-search" style="position:absolute;left:10px;top:50%;transform:translateY(-50%);color:var(--muted)"></i>
            <input id="searchInput" placeholder="Search Jobcard / Box / Type..." oninput="render()" style="padding:8px 8px 8px 30px;border-radius:8px;border:1px solid var(--border);font-size:13px;min-width:240px">
          </div>
          <button class="btn btn-primary" onclick="exportToExcel()"><i class="fa fa-file-excel"></i> Export</button>
        </div>
      </div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th style="width:40px"></th>
              <th>Jobcard</th>
              <th>SO Number</th>
              <th>Box No</th>
              <th>Type</th>
              <th>Follow-Up Date</th>
              <th>Status</th>
              <th style="text-align:right">Actions</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
        <div id="emptyState" style="text-align:center;padding:40px;color:var(--muted);display:none">
          <i class="fa fa-box-open" style="font-size:30px;opacity:0.5;margin-bottom:10px"></i><br>No records found
        </div>
      </div>
    </div>
  </main>
</div>

<div id="postponeModal" class="modal-overlay">
  <div class="modal">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px">
      <h3 style="margin:0">Postpone Follow-Up</h3>
      <i class="fa fa-times" onclick="closeModal('postponeModal')" style="cursor:pointer"></i>
    </div>
    <div id="postponeInfo" style="background:#eff6ff;padding:10px;border-radius:8px;font-size:12px;color:var(--primary-dark);margin-bottom:15px;border:1px solid #dbeafe"></div>
    
    <label class="form-label">Next Follow-Up Date</label>
    <input id="modalDate" class="form-input" type="date">

    
    <label class="form-label">Reason <span style="color:var(--danger)">*</span></label>
    <textarea id="modalRemark" rows="3" class="form-input" placeholder="Enter reason for postponing..."></textarea>
    
    <div style="display:flex;justify-content:flex-end;gap:10px">
      <button class="btn btn-ghost" onclick="closeModal('postponeModal')">Cancel</button>
      <button class="btn btn-primary" onclick="confirmPostpone()">Confirm</button>
    </div>
  </div>
</div>

<div id="remarkModal" class="modal-overlay">
  <div class="modal">
    <h3 style="margin-top:0">Add Remark</h3>
    <textarea id="simpleRemarkInput" rows="4" class="form-input" placeholder="Enter note..."></textarea>
    <div style="display:flex;justify-content:flex-end;gap:10px">
      <button class="btn btn-ghost" onclick="closeModal('remarkModal')">Cancel</button>
      <button class="btn btn-primary" onclick="confirmRemark()">Save Note</button>
    </div>
  </div>
</div>

<div class="toast-container" id="toastContainer"></div>

<script>
// --- CONFIGURATION ---
const DB = "furecordsv3";
const DELETED_DB = "delete_logs_v3";

const TYPE_LIMITS = {
  "METAL TRIAL": [7, 15, 30, 45, 60],
  "SPECIAL BITE BLOCK": [3, 7, 30, 60],
  "BITE BLOCK": [3, 7, 30, 60],
  "SPECIAL TRAY": [7, 15, 30, 60],
  "JIG TRIAL": [3, 7, 30, 60],
  "TEETH SETTING WITH FRAME": [7, 15, 30, 60],
  "TEETH SET": [7, 15, 30, 60],
  "BODY TRIAL": [3, 7, 15, 60],
  "ABUTMENT MILLING TRIAL": [3, 7, 30, 60],
  "RESIN TRIAL": [3, 7, 30, 60],
  "COMPONENTS": [7, 15, 30, 60],
  "DEFAULT": [3, 7, 15, 30]
};

// --- STATE ---
let records = [];

db.collection("records")
  .onSnapshot(snapshot => {
    records = [];
    snapshot.forEach(doc => records.push(doc.data()));
    render();
  });

let currentFilter = 'Total';
let editingId = null;

// --- UTILS ---
const pad = n => n.toString().padStart(2,"0");
function parseDate(str){ 
  if(!str) return null; 
  const p = str.split(" ")[0].split("/"); 
  return new Date(p[2], p[1]-1, p[0]); 
}
function formatDT(d){ 
  return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`; 
}
function addDays(dateStr, days) {
  const d = parseDate(dateStr);
  d.setDate(d.getDate() + days);
  const timePart = dateStr.split(" ")[1] || "09:00:00";
  return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${timePart}`;
}

// --- TOAST NOTIFICATIONS ---
function showToast(msg, type = 'success') {
  const c = document.getElementById('toastContainer');
  const t = document.createElement('div');
  t.className = `toast toast-${type}`;
  t.innerHTML = `<i class="fa ${type==='success'?'fa-check-circle':'fa-exclamation-circle'}"></i> <span>${msg}</span>`;
  c.appendChild(t);
  requestAnimationFrame(() => t.classList.add('show'));
  setTimeout(() => { t.classList.remove('show'); setTimeout(() => t.remove(), 300); }, 3000);
}

// --- RENDER LOGIC ---
function render(){
  const now = new Date(); now.setHours(0,0,0,0);
  const activeRecords = records.filter(r => r.status !== "Completed");
  
  let counts = {Total: activeRecords.length, Today: 0, Upcoming: 0, Backlog: 0};
  
  // Sort: Backlog > Today > Upcoming
  activeRecords.sort((a,b) => parseDate(a.todayFollow) - parseDate(b.todayFollow));

  // Count KPIs
  activeRecords.forEach(r => {
    const d = parseDate(r.todayFollow);
    if(d) {
      d.setHours(0,0,0,0);
      if(d.getTime() === now.getTime()) counts.Today++;
      else if(d < now) counts.Backlog++;
      else counts.Upcoming++;
    }
  });

  // Update KPI DOM
  document.getElementById('kTotal').innerText = counts.Total;
  document.getElementById('kToday').innerText = counts.Today;
  document.getElementById('kUpcoming').innerText = counts.Upcoming;
  document.getElementById('kBacklog').innerText = counts.Backlog;

  const tbody = document.getElementById('tableBody');
  tbody.innerHTML = "";
  const q = document.getElementById('searchInput').value.toLowerCase();
  let hasData = false;

  activeRecords.forEach(r => {
    // 1. Calculate Status for display
    const d = parseDate(r.todayFollow);
    let rowType = 'Upcoming'; 
    let badgeHtml = "";

    // -- LOGIC FOR STATUS --
    if(r.status === 'Postponed') {
        // BLUE
        badgeHtml = `<span class="badge badge-blue"><i class="fa fa-clock"></i> Postponed</span>`;
        // KPI counting logic remains based on date, or handled separately? 
        // Typically postponed items have a future date, so they fall into 'Upcoming' usually.
    } else if(d) {
        d.setHours(0,0,0,0);
        if(d < now) {
            // RED
            rowType = 'Backlog';
            badgeHtml = `<span class="badge badge-red"><i class="fa fa-triangle-exclamation"></i> Backlog</span>`;
        } else {
            // GREEN (Includes Today and Future)
            if(d.getTime() === now.getTime()) rowType = 'Today';
            badgeHtml = `<span class="badge badge-green"><i class="fa fa-circle-check"></i> Active</span>`;
        }
    }

    // 2. Filter Logic
    if(currentFilter !== 'Total' && currentFilter !== rowType && !(currentFilter === 'Backlog' && rowType === 'Backlog')) return;
    
    // 3. Search Logic
    if (q && !r.jobcard.toLowerCase().includes(q) && 
        !r.type.toLowerCase().includes(q) && 
        !(r.soNumber && r.soNumber.toLowerCase().includes(q)) &&
        !(r.boxNumber && r.boxNumber.toLowerCase().includes(q))) return;

    hasData = true;

    // 4. Render Row
    tbody.innerHTML += `
      <tr>
        <td><i id="icon-${r.id}" class="fa fa-chevron-right expand-btn" onclick="toggleRow('${r.id}')"></i></td>
        <td><b>${r.jobcard}</b></td>
        <td style="color:var(--primary);font-weight:700">${r.soNumber || "-"}</td>
        <td><span style="font-family:monospace;background:#f1f5f9;padding:2px 6px;border-radius:4px">${r.boxNumber || "-"}</span></td>
        <td>${r.type}</td>
        <td>${r.todayFollow}</td>
        <td>${badgeHtml}</td>
        <td style="text-align:right">
          <button class="btn btn-ghost" title="Add Note" onclick="openRemark('${r.id}')"><i class="fa fa-comment-dots"></i></button>
         <button class="btn btn-postpone" title="Postpone" onclick="openPostpone('${r.id}')">Postponed</button>
          <button class="btn btn-complete" title="Complete" onclick="complete('${r.id}')">Completed</button>
          <button class="btn btn-danger" title="Delete" onclick="del('${r.id}')"><i class="fa fa-trash"></i></button>
        </td>
      </tr>
      <tr id="row-${r.id}" class="remark-row">
        <td colspan="8">
          <div class="remark-box">
            <div style="font-weight:700;margin-bottom:8px;color:var(--primary)">Remark History</div>
            ${r.remark || "<span style='font-style:italic;opacity:0.7'>No remarks yet.</span>"}
          </div>
        </td>
      </tr>`;
  });

  document.getElementById('emptyState').style.display = hasData ? 'none' : 'block';
}

// --- ACTIONS ---
function setFilter(f){
  currentFilter = f;
  document.querySelectorAll('.kpi').forEach(k => k.classList.remove('active'));
  document.getElementById('kpi-'+f).classList.add('active');
  render();
}

function toggleRow(id){
  const row = document.getElementById('row-'+id);
  const icon = document.getElementById('icon-'+id);
  if(row.classList.contains('show')) {
    row.classList.remove('show');
    icon.className = 'fa fa-chevron-right expand-btn';
  } else {
    row.classList.add('show');
    icon.className = 'fa fa-chevron-down expand-btn';
  }
}

// Postpone Logic
function openPostpone(id){
  editingId = id;
  const r = records.find(x => x.id === id);
  const count = r.postponeCount || 0;
  const limits = TYPE_LIMITS[r.type] || TYPE_LIMITS["DEFAULT"];
  const daysToAdd = limits[Math.min(count, limits.length - 1)];
  const nextDate = addDays(r.todayFollow, daysToAdd);
  
  document.getElementById("postponeInfo").innerHTML = `<b>${r.type}</b><br>Postpone #${count + 1} &rarr; Adding <b>${daysToAdd} days</b>`;
  const dateOnly = nextDate.split(" ")[0].split("/").reverse().join("-");
document.getElementById("modalDate").value = dateOnly;

  document.getElementById("modalRemark").value = "";
  document.querySelector(".modal-overlay#postponeModal").style.display = "flex";
}

function confirmPostpone(){
  const r = records.find(x => x.id === editingId);
  const remark = document.getElementById("modalRemark").value.trim();
  if(!remark){ showToast("Reason required", "error"); return; }
  
  const selectedDate = document.getElementById("modalDate").value;
const oldTime = r.todayFollow.split(" ")[1] || "09:00:00";

// Convert YYYY-MM-DD â†’ DD/MM/YYYY
const d = selectedDate.split("-");
const formattedDate = `${d[2]}/${d[1]}/${d[0]}`;

r.todayFollow = `${formattedDate} ${oldTime}`;

  r.postponeCount = (r.postponeCount || 0) + 1;
  r.status = "Postponed";
  
  const ts = formatDT(new Date());
  r.remark = (r.remark || "") + `<div class="remark-entry"><span class="remark-time">${ts}</span> [Postponed] ${remark}</div>`;
  
  save(r)
  .then(() => {
    closeModal('postponeModal');
    showToast("Follow-up Postponed");
  });

 
}

// Remark Logic
function openRemark(id){
  editingId = id;
  document.getElementById("simpleRemarkInput").value = "";
  document.querySelector(".modal-overlay#remarkModal").style.display = "flex";
}

function confirmRemark(){
  const r = records.find(x => x.id === editingId);
  const txt = document.getElementById("simpleRemarkInput").value.trim();
  if(!txt) return;
  
  const ts = formatDT(new Date());
  r.remark = (r.remark || "") + `<div class="remark-entry"><span class="remark-time">${ts}</span> ${txt}</div>`;
  
 save(r)
.then(() => {
  closeModal('remarkModal');
  showToast("Note Added");
});

}

function closeModal(id) { document.getElementById(id).style.display = 'none'; editingId = null; }

function complete(id){
  if(!confirm("Mark as Completed?")) return;
  const r = records.find(x => x.id === id);
  r.completedAt = formatDT(new Date());
  r.status = "Completed";
save(r).then(() => showToast("Moved to Completed", "success"));

 
}

function del(id){
  if(!confirm("Delete permanently?")) return;
  const i = records.findIndex(x => x.id === id);
  const r = records[i];
  
  let d = JSON.parse(localStorage.getItem(DELETED_DB) || "[]");
  d.push({...r, deletedAt: formatDT(new Date())});
  localStorage.setItem(DELETED_DB, JSON.stringify(d));
  
  db.collection("records").doc(id).delete()
  .then(() => showToast("Record Deleted", "error"));

  
}

async function clearDatabase() {
  if(!confirm("WARNING: This will wipe ALL records. Continue?")) return;

  const snap = await db.collection("records").get();
  const batch = db.batch();

  snap.forEach(doc => batch.delete(doc.ref));
  await batch.commit();

  showToast("Database Cleared", "error");
}


function save(record){
  return db.collection("records")
    .doc(record.id)
    .set(record);
}

function logout(){ localStorage.removeItem("loggedInUser"); window.location.href = "login.html"; }

function exportToExcel() {
  const active = records.filter(r => r.status !== "Completed");
  const ws = XLSX.utils.json_to_sheet(active.map(r => ({
    Jobcard: r.jobcard, 
    SONumber: r.soNumber || "",
    BoxNumber: r.boxNumber || "",
    Type: r.type, 
    FollowUpDate: r.todayFollow, 
    Status: r.status || "Active",
    RemarkPlain: r.remark ? r.remark.replace(/<[^>]*>?/gm, ' | ') : ""
  })));
  const wb = XLSX.utils.book_new(); 
  XLSX.utils.book_append_sheet(wb, ws, "Active_List");
  XLSX.writeFile(wb, "Working_Summary.xlsx");
}


</script>
</body>
</html>
